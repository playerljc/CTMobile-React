"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof"),_classCallCheck2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.Back=Back,exports.Link=Link,exports.default=void 0,_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"))),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_jquery=_interopRequireDefault(require("jquery")),_react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_CtMobile=_interopRequireDefault(require("./CtMobile")),_Constant=_interopRequireDefault(require("./Constant")),_GlobalContext=_interopRequireDefault(require("./GlobalContext"));function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,a=new WeakMap;return(_getRequireWildcardCache=function(e){return e?a:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var a,r,i={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&((r=n?Object.getOwnPropertyDescriptor(e,a):null)&&(r.get||r.set)?Object.defineProperty(i,a,r):i[a]=e[a]);return i.default=e,t&&t.set(e,i),i}function initial(){var a=this;onHashchange=onHashchange.bind(this),window.addEventListener("hashchange",onHashchange,!1),(0,_jquery.default)(window.document).on("pageBeforeChange",function(e,t){a.setParameter(t)})}function onHashchange(){var e=window.location.hash;hashChange.call(this,e)}function hashChange(e,t){var a=this,r="";if(e){var i=(r=-1!==e.indexOf("?")?e.substring(1,e.indexOf("?")):e.substring(1)).lastIndexOf("_");if(-1===i)return!1;i=r.substring(0,i);if(!window.document.querySelector("[data-ct-data-role='page'],#"+i))return!1;a.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)])}else{if(a.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)]),a.ctmobile.getFirstPage().getPageId()!==a.ctmobile.getFirstPageId())return void a.ctmobile.createPage(a.ctmobile.getId(a.ctmobile.getFirstPageId()),function(e){e.start(_Constant.default._SLIDEDURATION,function(){a.removeFirstPage()})});r=a.ctmobile.getFirstPage().getId()}if(a.getPageById(r)){if(r===a.getLastPage().getId())return!1;for(var n=a.ctmobile.indexOfById(r),o=a.getHistoryLength()-1;n<o;o--)o===n+1?a.getPageByIndex(o).finish(_Constant.default._SLIDEDURATION):a.getPageByIndex(o).finish(0)}else a.ctmobile.createPage(r,function(e){e.start(_Constant.default._SLIDEDURATION,function(){var e;t&&t.reload&&1<a.getHistoryLength()&&(e=a.getHistoryLength()-2,(e=a.getPageByIndex(e))&&e.finish(0,null,t))})})}function indexOfHistoryByPageId(e){-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?")));for(var t=-1,a=0,r=this.getHistoryLength();a<r;a++)if(this.getPageByIndex(a).getPageId()===e){t=a;break}return t}function Link(r){var e=r.className,e=void 0===e?"":e,t=r.style,t=void 0===t?{}:t,a=r.children,i=(0,_react.useContext)(_GlobalContext.default);return _react.default.createElement("a",{className:e,style:t,onClick:function(){var e=r.pageId,e=void 0===e?"":e,t=r.parameter,t=void 0===t?"":t,a=r.reload,a=void 0===a?i.config.linkCaptureReload:a,e="".concat("#"+e,"?pageId=").concat(e).concat(t);i.router.startPage(e,{reload:a})}},a)}function Back(e){var t=e.className,t=void 0===t?"":t,a=e.style,a=void 0===a?{}:a,e=e.children,r=(0,_react.useContext)(_GlobalContext.default);return _react.default.createElement("a",{className:t,style:a,onClick:function(){return r.router.go(-1)}},e)}Link.propTypes={className:_propTypes.default.string,style:_propTypes.default.object,pageId:_propTypes.default.string,parameter:_propTypes.default.string,reload:_propTypes.default.bool},Back.propTypes={className:_propTypes.default.string,style:_propTypes.default.object};var Router=function(){function t(e){(0,_classCallCheck2.default)(this,t),Object.assign(this,{ctmobile:e,parameter:null,history:[]}),initial.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,r){var i=this,n="",o="";if(0!==e.indexOf("#")){var t,a=_CtMobile.default.getUrlParam(e),n=a.pageId,l=(delete a.pageId,[]);for(t in a)a.hasOwnProperty(t)&&l.push(t+"="+a[t]);o=l.join("&")?"?"+l.join("&"):"",s()}else e=e.substring(1),n=-1!==e.indexOf("?")?(o=e.substring(e.indexOf("?")),e.substring(0,e.indexOf("?"))):e,s();function s(){var e,t,a=i.ctmobile.getPageConfigAttribute(n,"mode");-1!==a.toLowerCase().indexOf("single")?-1===(t=indexOfHistoryByPageId.call(i,n))?(e=-1!==a.indexOf("singleInstance")&&i.ctmobile.getSingleInstance(n)?i.ctmobile.getSingleInstance(n).getId():i.ctmobile.getId(n+o),r&&r.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(i,"#"+e,r)):window.location.hash="#"+e):i.ctmobile.getPageByIndex(t)!==i.getLastPage()?i.go(-(i.getHistoryLength()-1-t)):i.ctmobile.fireEvent(i.getLastPage().getPageDOM(),"pageShow"):"standard"!==a&&"result"!==a||(e=i.ctmobile.getId(n+o),r&&r.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(i,"#"+e,r)):window.location.hash="#"+e)}}},{key:"go",value:function(e){window.history.go(e)}},{key:"back",value:function(){this.go(-1)}},{key:"setParameter",value:function(e){this.parameter=e}},{key:"getParameter",value:function(){var e=Object.assign({},this.parameter);return e.pageId&&delete e.pageId,e}},{key:"getPageById",value:function(e){return this.history[this.ctmobile.indexOfById(e)]}},{key:"getPageByIndex",value:function(e){return this.history[e]}},{key:"getLastPage",value:function(){return this.history[this.history.length-1]}},{key:"getHistoryLength",value:function(){return this.history.length}},{key:"addPage",value:function(e){this.history.push(e)}},{key:"removeFirstPage",value:function(){this.history.shift()}},{key:"removeLastPage",value:function(){this.history.pop()}},{key:"removePageByIndex",value:function(e){this.history.splice(e,1)}}]),t}(),_default=Router;exports.default=_default;