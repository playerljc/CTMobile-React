"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.Link=exports.Back=void 0,_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"))),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_jquery=_interopRequireDefault(require("jquery")),_react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_CtMobile=_interopRequireDefault(require("./CtMobile")),_Constant=_interopRequireDefault(require("./Constant")),_GlobalContext=require("./GlobalContext");function _createSuper(r){var a=_isNativeReflectConstruct();return function(){var e,t=(0,_getPrototypeOf2.default)(r);return e=a?(e=(0,_getPrototypeOf2.default)(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),(0,_possibleConstructorReturn2.default)(this,e)}}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function initial(){var r=this;onHashchange=onHashchange.bind(this),window.addEventListener("hashchange",onHashchange,!1),(0,_jquery.default)(window.document).on("pageBeforeChange",function(e,t){r.setParameter(t)})}function onHashchange(){var e=window.location.hash;hashChange.call(this,e)}function hashChange(e,t){var r=this,a="";if(e){var n=(a=-1!==e.indexOf("?")?e.substring(1,e.indexOf("?")):e.substring(1)).lastIndexOf("_");if(-1===n)return!1;n=a.substring(0,n);if(!window.document.querySelector("[data-ct-data-role='page'],#"+n))return!1;r.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)])}else{if(r.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)]),r.ctmobile.getFirstPage().getPageId()!==r.ctmobile.getFirstPageId())return void r.ctmobile.createPage(r.ctmobile.getId(r.ctmobile.getFirstPageId()),function(e){e.start(_Constant.default._SLIDEDURATION,function(){r.removeFirstPage()})});a=r.ctmobile.getFirstPage().getId()}if(r.getPageById(a)){if(a===r.getLastPage().getId())return!1;for(var i=r.ctmobile.indexOfById(a),o=r.getHistoryLength()-1;i<o;o--)o===i+1?r.getPageByIndex(o).finish(_Constant.default._SLIDEDURATION):r.getPageByIndex(o).finish(0)}else r.ctmobile.createPage(a,function(e){e.start(_Constant.default._SLIDEDURATION,function(){var e;t&&t.reload&&1<r.getHistoryLength()&&(e=r.getHistoryLength()-2,(e=r.getPageByIndex(e))&&e.finish(0,null,t))})})}function indexOfHistoryByPageId(e){-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?")));for(var t=-1,r=0,a=this.getHistoryLength();r<a;r++)if(this.getPageByIndex(r).getPageId()===e){t=r;break}return t}var Link=function(e){(0,_inherits2.default)(r,e);var t=_createSuper(r);function r(){return(0,_classCallCheck2.default)(this,r),t.apply(this,arguments)}return(0,_createClass2.default)(r,[{key:"render",value:function(){var n=this,e=this.props,t=e.className,r=void 0===t?"":t,t=e.style,i=void 0===t?{}:t;return _react.default.createElement(_GlobalContext.Consumer,null,function(a){return _react.default.createElement("a",{className:r,style:i,onClick:function(){var e=n.props,t=e.pageId,t=void 0===t?"":t,r=e.parameter,r=void 0===r?"":r,e=e.reload,e=void 0===e?a.config.linkCaptureReload:e,t="".concat("#"+t,"?pageId=").concat(t).concat(r);a.router.startPage(t,{reload:e})}},n.props.children)})}}]),r}(_react.default.Component),Back=((exports.Link=Link).propTypes={className:_propTypes.default.string,style:_propTypes.default.object,pageId:_propTypes.default.string,parameter:_propTypes.default.string,reload:_propTypes.default.bool},function(e){(0,_inherits2.default)(r,e);var t=_createSuper(r);function r(){return(0,_classCallCheck2.default)(this,r),t.apply(this,arguments)}return(0,_createClass2.default)(r,[{key:"render",value:function(){var t=this,e=this.props,r=e.className,a=void 0===r?"":r,r=e.style,n=void 0===r?{}:r;return _react.default.createElement(_GlobalContext.Consumer,null,function(e){return _react.default.createElement("a",{className:a,style:n,onClick:function(){e.router.go(-1)}},t.props.children)})}}]),r}(_react.default.Component)),Router=((exports.Back=Back).propTypes={className:_propTypes.default.string,style:_propTypes.default.object},function(){function t(e){(0,_classCallCheck2.default)(this,t),Object.assign(this,{ctmobile:e,parameter:null,history:[]}),initial.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,a){var n=this,i="",o="";if(0!==e.indexOf("#")){var t,r=_CtMobile.default.getUrlParam(e),i=r.pageId,s=(delete r.pageId,[]);for(t in r)r.hasOwnProperty(t)&&s.push(t+"="+r[t]);o=s.join("&")?"?"+s.join("&"):"",l()}else e=e.substring(1),i=-1!==e.indexOf("?")?(o=e.substring(e.indexOf("?")),e.substring(0,e.indexOf("?"))):e,l();function l(){var e,t,r=n.ctmobile.getPageConfigAttribute(i,"mode");-1!==r.toLowerCase().indexOf("single")?-1===(t=indexOfHistoryByPageId.call(n,i))?(e=-1!==r.indexOf("singleInstance")&&n.ctmobile.getSingleInstance(i)?n.ctmobile.getSingleInstance(i).getId():n.ctmobile.getId(i+o),a&&a.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(n,"#"+e,a)):window.location.hash="#"+e):n.ctmobile.getPageByIndex(t)!==n.getLastPage()?n.go(-(n.getHistoryLength()-1-t)):n.ctmobile.fireEvent(n.getLastPage().getPageDOM(),"pageShow"):"standard"!==r&&"result"!==r||(e=n.ctmobile.getId(i+o),a&&a.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(n,"#"+e,a)):window.location.hash="#"+e)}}},{key:"go",value:function(e){window.history.go(e)}},{key:"back",value:function(){this.go(-1)}},{key:"setParameter",value:function(e){this.parameter=e}},{key:"getParameter",value:function(){var e=Object.assign({},this.parameter);return e.pageId&&delete e.pageId,e}},{key:"getPageById",value:function(e){return this.history[this.ctmobile.indexOfById(e)]}},{key:"getPageByIndex",value:function(e){return this.history[e]}},{key:"getLastPage",value:function(){return this.history[this.history.length-1]}},{key:"getHistoryLength",value:function(){return this.history.length}},{key:"addPage",value:function(e){this.history.push(e)}},{key:"removeFirstPage",value:function(){this.history.shift()}},{key:"removeLastPage",value:function(){this.history.pop()}},{key:"removePageByIndex",value:function(e){this.history.splice(e,1)}}]),t}()),_default=Router;exports.default=_default;