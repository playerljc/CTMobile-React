"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.Back=exports.Link=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_jquery=_interopRequireDefault(require("jquery")),_react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_CtMobile=_interopRequireDefault(require("./CtMobile")),_Constant=_interopRequireDefault(require("./Constant")),_GlobalContext=require("./GlobalContext");function initial(){var r=this;onHashchange=onHashchange.bind(this),window.addEventListener("hashchange",onHashchange,!1),(0,_jquery.default)(window.document).on("pageBeforeChange",function(e,t){r.setParameter(t)})}function onHashchange(){var e=window.location.hash;hashChange.call(this,e)}function hashChange(e,r){var a=this,t="";if(e){var i=(t=-1!==e.indexOf("?")?e.substring(1,e.indexOf("?")):e.substring(1)).lastIndexOf("_");if(-1===i)return!1;var n=t.substring(0,i);if(!window.document.querySelector("[data-ct-data-role='page'],#"+n))return!1;a.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)])}else{if(a.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)]),a.ctmobile.getFirstPage().getPageId()!==a.ctmobile.getFirstPageId())return void a.ctmobile.createPage(a.ctmobile.getId(a.ctmobile.getFirstPageId()),function(e){e.start(_Constant.default._SLIDEDURATION,function(){a.removeFirstPage()})});t=a.ctmobile.getFirstPage().getId()}if(a.getPageById(t)){if(t===a.getLastPage().getId())return!1;for(var o=a.ctmobile.indexOfById(t),s=a.getHistoryLength()-1;o<s;s--)s===o+1?a.getPageByIndex(s).finish(_Constant.default._SLIDEDURATION):a.getPageByIndex(s).finish(0)}else a.ctmobile.createPage(t,function(e){e.start(_Constant.default._SLIDEDURATION,function(){if(r&&r.reload&&1<a.getHistoryLength()){var e=a.getHistoryLength()-2,t=a.getPageByIndex(e);t&&t.finish(0,null,r)}})})}function indexOfHistoryByPageId(e){-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?")));for(var t=-1,r=0,a=this.getHistoryLength();r<a;r++)if(this.getPageByIndex(r).getPageId()===e){t=r;break}return t}var Link=function(e){function t(){return(0,_classCallCheck2.default)(this,t),(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(t).apply(this,arguments))}return(0,_inherits2.default)(t,e),(0,_createClass2.default)(t,[{key:"render",value:function(){var u=this,e=this.props,t=e.className,r=void 0===t?"":t,a=e.style,i=void 0===a?{}:a;return _react.default.createElement(_GlobalContext.Consumer,null,function(l){return _react.default.createElement("a",{className:r,style:i,onClick:function(){var e=u.props,t=e.pageId,r=void 0===t?"":t,a=e.parameter,i=void 0===a?"":a,n=e.reload,o=void 0===n?l.config.linkCaptureReload:n,s="".concat("#"+r,"?pageId=").concat(r).concat(i);l.router.startPage(s,{reload:o})}},u.props.children)})}}]),t}(_react.default.Component);(exports.Link=Link).propTypes={className:_propTypes.default.string,style:_propTypes.default.object,pageId:_propTypes.default.string,parameter:_propTypes.default.string,reload:_propTypes.default.bool};var Back=function(e){function t(){return(0,_classCallCheck2.default)(this,t),(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(t).apply(this,arguments))}return(0,_inherits2.default)(t,e),(0,_createClass2.default)(t,[{key:"render",value:function(){var t=this,e=this.props,r=e.className,a=void 0===r?"":r,i=e.style,n=void 0===i?{}:i;return _react.default.createElement(_GlobalContext.Consumer,null,function(e){return _react.default.createElement("a",{className:a,style:n,onClick:function(){e.router.go(-1)}},t.props.children)})}}]),t}(_react.default.Component);(exports.Back=Back).propTypes={className:_propTypes.default.string,style:_propTypes.default.object};var Router=function(){function t(e){(0,_classCallCheck2.default)(this,t),Object.assign(this,{ctmobile:e,parameter:null,history:[]}),initial.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,a){var i=this,n="",o="";if(0!==e.indexOf("#")){var t=_CtMobile.default.getUrlParam(e);n=t.pageId,delete t.pageId;var r=[];for(var s in t)t.hasOwnProperty(s)&&r.push(s+"="+t[s]);o=r.join("&")?"?"+r.join("&"):"",l()}else e=e.substring(1),n=-1!==e.indexOf("?")?(o=e.substring(e.indexOf("?")),e.substring(0,e.indexOf("?"))):e,l();function l(){var e,t=i.ctmobile.getPageConfigAttribute(n,"mode");if(-1!==t.toLowerCase().indexOf("single")){var r=indexOfHistoryByPageId.call(i,n);-1===r?(e=-1!==t.indexOf("singleInstance")&&i.ctmobile.getSingleInstance(n)?i.ctmobile.getSingleInstance(n).getId():i.ctmobile.getId(n+o),a&&a.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(i,"#"+e,a)):window.location.hash="#"+e):i.ctmobile.getPageByIndex(r)!==i.getLastPage()?i.go(-(i.getHistoryLength()-1-r)):i.ctmobile.fireEvent(i.getLastPage().getPageDOM(),"pageShow")}else"standard"!==t&&"result"!==t||(e=i.ctmobile.getId(n+o),a&&a.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(i,"#"+e,a)):window.location.hash="#"+e)}}},{key:"go",value:function(e){window.history.go(e)}},{key:"back",value:function(){this.go(-1)}},{key:"setParameter",value:function(e){this.parameter=e}},{key:"getParameter",value:function(){var e=Object.assign({},this.parameter);return e.pageId&&delete e.pageId,e}},{key:"getPageById",value:function(e){return this.history[this.ctmobile.indexOfById(e)]}},{key:"getPageByIndex",value:function(e){return this.history[e]}},{key:"getLastPage",value:function(){return this.history[this.history.length-1]}},{key:"getHistoryLength",value:function(){return this.history.length}},{key:"addPage",value:function(e){this.history.push(e)}},{key:"removeFirstPage",value:function(){this.history.shift()}},{key:"removeLastPage",value:function(){this.history.pop()}},{key:"removePageByIndex",value:function(e){this.history.splice(e,1)}}]),t}(),_default=Router;exports.default=_default;