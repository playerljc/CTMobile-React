"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"))),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_react=_interopRequireDefault(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_jquery=_interopRequireDefault(require("jquery")),_Page=_interopRequireDefault(require("./Page")),_Router=_interopRequireDefault(require("./Router")),_BroadCast=_interopRequireDefault(require("./BroadCast"));function readyPromise(){return new Promise(function(e){return(0,_jquery.default)(window.document).ready(function(){e()})})}function DOMContentLoadedPromise(){return new Promise(function(e){window.addEventListener("DOMContentLoaded",function(){return e()})})}function devicereadyPromise(){return new Promise(function(e){window.document.addEventListener("deviceready",function(){return e()})})}function _fireEvent(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_jquery.default)(e).trigger(t,n)}function _createPage(o,s){var u=this;return new Promise(function(n,r){var i,e=o.substring(0,o.lastIndexOf("_")),t=u.getPageConfigAttribute(e,"mode"),a=u.getSingleInstance(e);-1!==t.toLowerCase().indexOf("singleinstance")&&a?(s&&s(a),n()):(i=u.config.router[e])?((t=i.component).then?t:Promise.resolve(t)).then(function(e){var t;e?(e=e.default||e,t=(0,_jquery.default)('<div data-ct-data-role="page"></div>')[0],e=_Page.default.create(t)(e),e=_react.default.createElement(e,{ctMobile:u,id:o,config:i.config||{},callback:s}),u.config.getPageWrap&&u.config.getPageWrap instanceof Function&&(e=u.config.getPageWrap(e)),document.body.appendChild(t),_reactDom.default.render(e,t,function(){n()})):r()}).catch(function(e){r(e)}):r()})}function onReady(){var i=this;this.hasInited||(this.hasInited=!0,this.bodyDOM=window.document.body,this.singleInstances=null,this.maskDOM=(0,_jquery.default)("<div class='ct-page-mask'>\n       <div opt='animation' class='la-ball-circus la-dark' style='color:#3e98f0;'>\n         <div></div>\n         <div></div>\n         <div></div>\n         <div></div>\n         <div></div>\n       </div>\n      </div>")[0],this.bodyDOM.appendChild(this.maskDOM),_fireEvent(window.document,"pageBeforeChange",[CtMobileFactory.getUrlParam(window.location.hash)]),_createPage.call(this,this.getFirstId(),function(e){e.start(0,function(){if(!window.location.hash)return!1;var e=i.getPageIdByHash();if(!e)return!1;var t="#".concat(e),n=i.getParameterByHash(),r=CtMobileFactory.getUrlParam("".concat(t).concat(n));i.startPage("".concat(t).concat(n).concat(n?r.pageId?"":"&pageId=".concat(e):"?pageId=".concat(e)),{reload:i.config.linkCaptureReload})})}))}function init(){var e=this.config.supportCordova,e=void 0!==e&&e;onReady=onReady.bind(this),e?Promise.all([readyPromise(),DOMContentLoadedPromise(),devicereadyPromise()]).then(function(){onReady(),_fireEvent(window.document,"DOMContentAndDeviceReady")}).catch(function(e){}):((0,_jquery.default)(window.document).ready(onReady),window.addEventListener("DOMContentLoaded",onReady))}var CtMobile=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.config=e,this.hasInited=!1,this.zIndex=0,this.router=new _Router.default(this),this.borasdcast=new _BroadCast.default,init.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,t){this.router.startPage(e,t)}},{key:"createPage",value:function(e,t){return _createPage.call(this,e,t)}},{key:"back",value:function(){this.router.go(-1)}},{key:"getPageConfigAttribute",value:function(e,t){e=this.config.router[e];if(e.config){var n=e.config[t];if(!n)switch(t){case"mode":n="standard";break;case"transition":n="material"}return n}var r="";switch(t){case"mode":r="standard";break;case"transition":r="material"}return r}},{key:"getFirstId",value:function(){return this.getId(this.getFirstPageId())}},{key:"getId",value:function(e){var t=e.indexOf("?");return-1!==t?e.substring(0,t)+"_"+(new Date).getTime()+e.substring(t):e+"_"+(new Date).getTime()}},{key:"getPageIdByHash",value:function(){var e=window.location.hash;return e?(-1!==e.indexOf("?")?e=e.substring(0,e.lastIndexOf("?")):e).substring(1,e.lastIndexOf("_")):""}},{key:"getParameterByHash",value:function(){var e=window.location.hash;return e&&-1!==e.indexOf("?")?e.substring(e.lastIndexOf("?")):""}},{key:"getFirstPageId",value:function(){var e,t;for(t in this.config.router)if(this.config.router[t].isFirst){e=t;break}return e||"index"}},{key:"getPageById",value:function(e){return this.router.getPageById(this.indexOfById(e))}},{key:"getSingleInstance",value:function(e){return this.singleInstances||(this.singleInstances={}),this.singleInstances[e]}},{key:"fireEvent",value:function(e,t,n){_fireEvent(e,t,n)}},{key:"getPageByIndex",value:function(e){return this.router.getPageByIndex(e)}},{key:"indexOfById",value:function(e){for(var t=-1,n=0,r=this.getHistoryLength();n<r;n++)if(this.getPageByIndex(n).getId()===e){t=n;break}return t}},{key:"getFirstPage",value:function(){return this.router.getPageByIndex(0)}},{key:"getLastPage",value:function(){return this.router.getLastPage()}},{key:"getParameter",value:function(){return this.router.getParameter()}},{key:"getHistoryLength",value:function(){return this.router.getHistoryLength()}},{key:"getRequest",value:function(e){return 0!==this.getHistoryLength()&&1!==this.getHistoryLength()&&!((e=this.indexOfById(e.getId()))<=0||e>this.getHistoryLength()-1)&&this.getPageByIndex(this.getHistoryLength()-2).requestIntent||{}}},{key:"registerReceiver",value:function(e,t,n){this.borasdcast.registerReceiver(e,t,n)}},{key:"executeReceiverById",value:function(e,t){this.borasdcast.executeReceiverById(e,t)}},{key:"unregisterReceiver",value:function(e,t){this.borasdcast.unregisterReceiver(e,t)}},{key:"unregisterReceiverByDom",value:function(e){this.borasdcast.unregisterReceiverByDom(e)}},{key:"sendBroadcast",value:function(e){this.borasdcast.sendBroadcast(e)}},{key:"sendOrderedBroadcast",value:function(e){this.borasdcast.sendOrderedBroadcast(e)}}]),t}(),CtMobileFactory={getUrlParam:function(e){var t=/([^&=]+)=([\w\W]*?)(&|$)/g,e=/^[^\?]+\?([\w\W]+)$/.exec(e),n={};if(e&&e[1])for(var r,i=e[1];null!=(r=t.exec(i));)n[r[1]]=decodeURI(r[2]);return n},create:function(e){return new CtMobile(e)}},_default=CtMobileFactory;exports.default=_default;