"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof"),_classCallCheck2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"))),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_react=_interopRequireWildcard(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_propTypes=_interopRequireDefault(require("prop-types")),_jquery=_interopRequireDefault(require("jquery")),_Constant=_interopRequireDefault(require("./Constant")),_GlobalContext=require("./GlobalContext");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(_getRequireWildcardCache=function(e){return e?i:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var i,r,a={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&((r=n?Object.getOwnPropertyDescriptor(e,i):null)&&(r.get||r.set)?Object.defineProperty(a,i,r):a[i]=e[i]);return a.default=e,t&&t.set(e,a),a}function _createSuper(i){var r=_isNativeReflectConstruct();return function(){var e,t=(0,_getPrototypeOf2.default)(i);return e=r?(e=(0,_getPrototypeOf2.default)(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),(0,_possibleConstructorReturn2.default)(this,e)}}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function forEach(e,t){for(var i=0,r=e.length;i<r;i++)t&&t.call(e[i],e[i],i)}function go(e){this.ctMobile.router.go(e)}function createPageDOM(){var e=this,t=(this._pDom.setAttribute("id",this.pageId),forEach(this._pDom.querySelectorAll("[id]"),function(){this.setAttribute("id",e.id+this.getAttribute("id"))}),forEach(this._pDom.querySelectorAll("label[for]"),function(){this.setAttribute("for",e.id+this.getAttribute("for"))}),forEach(this._pDom.querySelectorAll("input[list]"),function(){this.setAttribute("list",e.id+this.getAttribute("list"))}),forEach(this._pDom.querySelectorAll("datalist[id]"),function(){this.setAttribute("id",e.id+this.getAttribute("id"))}),this.transition=this.ctMobile.getPageConfigAttribute(this.pageId,"transition"),addEventListeners.call(this),this.ctMobile.getPageConfigAttribute(this.pageId,"intentfilterAction")),i=this.ctMobile.getPageConfigAttribute(this.pageId,"intentfilterCategorys"),r=this.ctMobile.getPageConfigAttribute(this.pageId,"intentfilterPriority");t&&this.ctMobile.registerReceiver({el:this._pDom,action:t,priority:r?parseInt(r):0,categorys:i?i.split(" "):[]},this.pageReceiver,this)}function layout(){slideByTransition.call(this,this.transition,"reset",0)}function addEventListeners(){var t=this;function e(e){console.log(_Constant.default._debugger,"------------------------------onTransitionAndAnimationEnd"),"transitionend"===e.type&&"page"!==e.target.getAttribute("data-ct-data-role")||t.pageTransitionType&&("start"===t.pageTransitionType?(delete t.pageTransitionType,pageStartTransitionEndCallback.call(t,e)):"finish"===t.pageTransitionType&&(delete t.pageTransitionType,pageFinishTransitioneEndCallback.call(t,e)))}t.getPageJO().on({pageBeforeShow:t.pageBeforeShow.bind(t),pageShow:t.pageShow.bind(t),pageAfterShow:t.pageAfterShow.bind(t),pageBeforePause:t.pageBeforePause.bind(t),pageAfterPause:t.pageAfterPause.bind(t),pageBeforeRestore:t.pageBeforeRestore.bind(t),pageRestore:t.pageRestore.bind(t),pageAfterRestore:t.pageAfterRestore.bind(t),pageBeforeDestroy:t.pageBeforeDestroy.bind(t),pageResult:t.pageResult.bind(t),pageReceiver:t.pageReceiver.bind(t)}),t.getPageDOM().addEventListener("transitionend",e,!1),t.getPageDOM().addEventListener("animationend",e,!1)}function pageFinishTransitioneEndCallback(e){var t,i=this;"transitionend"===e.type&&"page"!==e.target.getAttribute("data-ct-data-role")||"animationend"===e.type&&"page"!==e.target.getAttribute("data-ct-data-role")||(e.stopPropagation(),e.preventDefault(),i.getPageDOM().classList.remove("materialHide"),i.getPageDOM().classList.remove("active"),i.ctMobile.maskDOM.style.display="none",i.changeKey=!1,-1===(e=i.ctMobile.getPageConfigAttribute(i.pageId,"mode")).toLowerCase().indexOf("singleinstance")&&_reactDom.default.unmountComponentAtNode(i.getPageDOM())&&i.getPageDOM().parentNode.removeChild(i.getPageDOM()),1<i.ctMobile.getHistoryLength()&&(t=i.ctMobile.getHistoryLength()-2,i.ctMobile.fireEvent(i.ctMobile.getPageByIndex(t).getPageDOM(),"pageAfterRestore"),-1!==e.toLowerCase().lastIndexOf("result")&&i.resultIntent&&i.resultIntent.resultCode&&i.ctMobile.fireEvent(i.ctMobile.getPageByIndex(t).getPageDOM(),"pageResult",[i.resultIntent.resultCode,i.resultIntent.bundle])),i.ctMobile.router.removeLastPage(),i.pageTransitionEndCallback&&i.pageTransitionEndCallback())}function pageStartTransitionEndCallback(e){var t=this;"transitionend"===e.type&&"page"!==e.target.getAttribute("data-ct-data-role")||"animationend"===e.type&&"page"!==e.target.getAttribute("data-ct-data-role")||(e.stopPropagation(),e.preventDefault(),t.getPageDOM().classList.remove("materialShow"),t.ctMobile.getLastPage().getPageDOM().classList.remove("active"),t.ctMobile.maskDOM.style.display="none",t.changeKey=!1,t.ctMobile.router.addPage(t),t.ctMobile.fireEvent(t.getPageDOM(),"pageAfterShow"),2<=t.ctMobile.getHistoryLength()&&t.ctMobile.fireEvent(t.ctMobile.getPageByIndex(t.ctMobile.getHistoryLength()-2).getPageDOM(),"pageAfterPause"),t.pageTransitionEndCallback&&t.pageTransitionEndCallback())}function slideByTransition(e,t,i,r){var a=this,n=0,o=0;("reset"===t?function(){new RegExp(/.+left/g).exec(e)?n="100%":new RegExp(/.+right/g).exec(e)?n="-100%":new RegExp(/.+up/g).exec(e)?o="100%":new RegExp(/.+down/g).exec(e)&&(o="-100%"),0===e.indexOf("wx")&&0!==i?(delete a.ctMobile.getPageByIndex(a.ctMobile.getHistoryLength()-2).pageTransitionType,slide.call(a.ctMobile.getPageByIndex(a.ctMobile.getHistoryLength()-2),0,0,i/2)):0===e.indexOf("push")&&0!==i&&(delete a.ctMobile.getPageByIndex(a.ctMobile.getHistoryLength()-2).pageTransitionType,slide.call(a.ctMobile.getPageByIndex(a.ctMobile.getHistoryLength()-2),0,0,i)),0===e.indexOf("material")?0!==i&&(r&&r(),this.getPageDOM().classList.add("materialHide")):slide.call(this,n,o,i,r)}:function(){0===e.indexOf("wx")&&0!==i?(delete a.ctMobile.getLastPage().pageTransitionType,new RegExp(/.+left/g).exec(e)?slide.call(a.ctMobile.getLastPage(),"-20%",o,i/2):new RegExp(/.+right/g).exec(e)?slide.call(a.ctMobile.getLastPage(),"20%",o,i/2):new RegExp(/.+up/g).exec(e)?slide.call(a.ctMobile.getLastPage(),n,"-20%",i/2):new RegExp(/.+down/g).exec(e)&&slide.call(a.ctMobile.getLastPage(),n,"20%",i/2)):0===e.indexOf("push")&&0!==i&&(delete a.ctMobile.getLastPage().pageTransitionType,new RegExp(/.+left/g).exec(e)?slide.call(a.ctMobile.getLastPage(),"-100%",o,i):new RegExp(/.+right/g).exec(e)?slide.call(a.ctMobile.getLastPage(),"100%",o,i):new RegExp(/.+up/g).exec(e)?slide.call(a.ctMobile.getLastPage(),n,"-100%",i):new RegExp(/.+down/g).exec(e)&&slide.call(a.ctMobile.getLastPage(),n,"100%",i)),0===e.indexOf("material")?0!==i&&(r&&r(),a.getPageDOM().classList.add("materialShow")):slide.call(this,n,o,i,r)}).call(a)}function slide(e,t,i,r){var a=this;function n(){a.getPageJO().css({transform:"translate3d("+e+","+t+",0)",transition:"transform "+i+"ms cubic-bezier(0.1,0.25,0.1,1)"})}r&&r(),0===i?n():window.setTimeout(n,100)}function PageWrap(i){return(0,_react.forwardRef)(function(e,t){return _react.default.createElement(i,(0,_extends2.default)({ref:t,wrapRef:t},e),e.children)})}var Page={create:function(s){return function(o){var e=function(e){(0,_inherits2.default)(n,e);var a=_createSuper(n);function n(e){(0,_classCallCheck2.default)(this,n),t=a.call(this,e);var t,i=e.ctMobile,r=e.id,e=e.config,e=void 0===e?{}:e;return Object.assign((0,_assertThisInitialized2.default)(t),{ctMobile:i,config:e,_pDom:s,id:r,pageId:r.substring(0,r.lastIndexOf("_")),transition:"material",changeKey:!1,pageTransitionType:null,pageTransitionEndCallback:null}),t.ins=_react.default.createRef(),t.PageComponent=PageWrap(o),createPageDOM.call((0,_assertThisInitialized2.default)(t)),layout.call((0,_assertThisInitialized2.default)(t)),t}return(0,_createClass2.default)(n,[{key:"componentDidMount",value:function(){this.ins.current&&this.ins.current.pageCreate&&this.ins.current.pageCreate();var e=this.getPageId();-1!==this.ctMobile.getPageConfigAttribute(e,"mode").toLowerCase().indexOf("singleinstance")&&(this.ctMobile.getSingleInstance(e)||(this.ctMobile.singleInstances[e]=this)),this.props.callback&&this.props.callback(this)}},{key:"pageBeforeShow",value:function(e){this.ins.current&&this.ins.current.pageBeforeShow&&this.ins.current.pageBeforeShow(e)}},{key:"pageShow",value:function(e){this.ins.current&&this.ins.current.pageShow&&this.ins.current.pageShow(e)}},{key:"pageAfterShow",value:function(e){this.ins.current&&this.ins.current.pageAfterShow&&this.ins.current.pageAfterShow(e)}},{key:"pageBeforePause",value:function(e){this.ins.current&&this.ins.current.pageBeforePause&&this.ins.current.pageBeforePause(e)}},{key:"pageAfterPause",value:function(e){this.ins.current&&this.ins.current.pageAfterPause&&this.ins.current.pageAfterPause(e)}},{key:"pageBeforeRestore",value:function(e){this.ins.current&&this.ins.current.pageBeforeRestore&&this.ins.current.pageBeforeRestore(e)}},{key:"pageRestore",value:function(e){this.ins.current&&this.ins.current.pageRestore&&this.ins.current.pageRestore(e)}},{key:"pageAfterRestore",value:function(e){this.ins.current&&this.ins.current.pageAfterRestore&&this.ins.current.pageAfterRestore(e)}},{key:"pageBeforeDestroy",value:function(e){this.ins.current&&this.ins.current.pageBeforeDestroy&&this.ins.current.pageBeforeDestroy(e)}},{key:"pageResult",value:function(e,t,i){this.ins.current&&this.ins.current.pageResult&&this.ins.current.pageResult(e,t,i)}},{key:"pageReceiver",value:function(e,t){this.ins.current&&this.ins.current.pageReceiver&&this.ins.current.pageReceiver(e,t)}},{key:"start",value:function(e,t){var i=this;i.changeKey||(i.changeKey=!0,i.pageTransitionType="start",i.pageTransitionEndCallback=t,0!==i.ctMobile.getHistoryLength()&&i.ctMobile.fireEvent(i.ctMobile.getLastPage().getPageDOM(),"pageBeforePause"),i.ctMobile.fireEvent(i.getPageDOM(),"pageBeforeShow"),0!==e&&(i.ctMobile.maskDOM.style.display="block"),i.getPageDOM().classList.add("active"),i.getPageDOM().style.zIndex=++i.ctMobile.zIndex,i.ctMobile.fireEvent(i.getPageDOM(),"pageShow"),slideByTransition.call(i,i.transition,"show",0===e?0:_Constant.default._SLIDEDURATION),0===e&&(i.ctMobile.router.addPage(i),i.changeKey=!1,i.ctMobile.fireEvent(i.getPageDOM(),"pageAfterShow"),t&&t()))}},{key:"finish",value:function(e,t,i){var r,a,n=this;n.changeKey||(n.changeKey=!0,n.pageTransitionType="finish",n.ctMobile.zIndex--,n.pageTransitionEndCallback=t,-1===(r=n.ctMobile.getPageConfigAttribute(n.getPageId(),"mode")).toLowerCase().indexOf("singleinstance")?(n.ctMobile.fireEvent(n.getPageDOM(),"pageBeforeDestroy"),n.ctMobile.unregisterReceiverByDom(n.getPageDOM())):n.ctMobile.fireEvent(n.getPageDOM(),"pageAfterPause"),a=n.ctMobile.getHistoryLength()-2,!(1<n.ctMobile.getHistoryLength())||i&&i.reload||n.ctMobile.fireEvent(n.ctMobile.getPageByIndex(a).getPageDOM(),"pageBeforeRestore"),0!==e&&(n.ctMobile.maskDOM.style.display="block"),!(1<n.ctMobile.getHistoryLength())||i&&i.reload||(n.ctMobile.getPageByIndex(a).getPageDOM().classList.add("active"),n.ctMobile.fireEvent(n.ctMobile.getPageByIndex(a).getPageDOM(),"pageRestore")),slideByTransition.call(this,this.transition,"reset",0===e?0:_Constant.default._SLIDEDURATION),0===e&&(n.getPageDOM().classList.remove("active"),n.changeKey=!1,-1===r.toLowerCase().indexOf("singleinstance")&&_reactDom.default.unmountComponentAtNode(n.getPageDOM())&&n.getPageDOM().parentNode.removeChild(n.getPageDOM()),!(1<n.ctMobile.getHistoryLength())||i&&i.reload||(n.ctMobile.fireEvent(n.ctMobile.getPageByIndex(a).getPageDOM(),"pageAfterRestore"),-1!==r.toLowerCase().lastIndexOf("result")&&n.resultIntent&&n.resultIntent.resultCode&&n.ctMobile.fireEvent(n.ctMobile.getPageByIndex(a).getPageDOM(),"pageResult",[n.resultIntent.resultCode,n.resultIntent.bundle])),1<n.ctMobile.getHistoryLength()&&i&&i.reload?n.ctMobile.router.removePageByIndex(a,1):n.ctMobile.router.removeLastPage(),t&&t()))}},{key:"getPageDOM",value:function(){return this._pDom}},{key:"getPageJO",value:function(){return this._pJO||(this._pJO=(0,_jquery.default)(this.getPageDOM())),this._pJO}},{key:"getId",value:function(){return this.id}},{key:"getPageId",value:function(){return this.pageId}},{key:"setRequest",value:function(){this.requestIntent={requestCode:0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",bundle:1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}}}},{key:"getRequest",value:function(e){return this.ctMobile.getRequest(this)}},{key:"setResult",value:function(){this.resultIntent={resultCode:0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",bundle:1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}}}},{key:"getResult",value:function(e){return this.resultIntent}},{key:"over",value:function(){go.call(this,-1)}},{key:"getCtMobile",value:function(){return this.ctMobile}},{key:"render",value:function(){var e={parent:this,_pDom:this._pDom,pageId:this.pageId},t=this.PageComponent;return _react.default.createElement(_GlobalContext.Provider,{value:this.getCtMobile()},_react.default.createElement(t,(0,_extends2.default)({ref:this.ins},this.props,e)))}}]),n}(_react.default.Component);return o.propTypes={ctMobile:_propTypes.default.object,id:_propTypes.default.string,config:_propTypes.default.object,callback:_propTypes.default.func,parent:_propTypes.default.object,_pDom:_propTypes.default.object,pageId:_propTypes.default.string},e.propTypes={ctMobile:_propTypes.default.object,id:_propTypes.default.string,config:_propTypes.default.object,callback:_propTypes.default.func},e}}},_default=Page;exports.default=_default;